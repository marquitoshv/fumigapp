<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recetas de Fumigaci√≥n</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111" />

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#111;
      --card2:#151515;
      --text:#f4f4f4;
      --muted:#bdbdbd;
      --line:#242424;
      --ok:#27c07d;
      --bad:#ff5b5b;
      --btn:#f4f4f4;
      --btnText:#111;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070707, #0b0b0b);
      color:var(--text);
    }
    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 88px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 6px 0 14px;
    }
    h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.2px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      padding: 6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      margin: 12px 0;
      backdrop-filter: blur(6px);
    }
    .card h2{
      font-size: 14px;
      margin:0 0 10px;
      color: var(--text);
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,.25);
    }
    .row{
      display:flex;
      gap:10px;
    }
    .row > *{flex:1}
    button{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
    }
    .btn{
      background: var(--btn);
      color: var(--btnText);
      font-weight: 600;
    }
    .btn2{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--line);
    }
    .btnDanger{
      background: rgba(255,91,91,.12);
      color: #ff8b8b;
      border:1px solid rgba(255,91,91,.35);
    }
    .btnOk{
      background: rgba(39,192,125,.12);
      color:#7ff0be;
      border:1px solid rgba(39,192,125,.35);
    }
    .msg{
      margin-top:10px;
      font-size: 12px;
      color: var(--muted);
    }
    .msg.bad{color: var(--bad)}
    .msg.ok{color: var(--ok)}

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .itemTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .itemTitle{
      font-size: 14px;
      margin:0;
      font-weight: 700;
    }
    .itemMeta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .itemBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .ingredients{
      margin-top:10px;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:10px;
      display:grid;
      gap:6px;
    }
    .ingRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 13px;
      color: var(--text);
    }
    .ingRow span:last-child{color: var(--muted)}
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    /* Bottom tabs */
    .tabs{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10,10,10,.9);
      border-top:1px solid var(--line);
      backdrop-filter: blur(8px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
    }
    .tabsInner{
      max-width: 900px;
      margin: 0 auto;
      display:flex;
      gap:10px;
    }
    .tabBtn{
      flex:1;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
    }
    .tabBtn.active{
      background: var(--btn);
      color: var(--btnText);
      border-color: transparent;
    }

    /* License wall */
    #licenseWall{
      display:none;
      max-width:520px;
      margin: 60px auto;
      padding: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 18px;
    }
    #licenseWall h2{margin:0 0 10px; font-size: 18px;}
  </style>
</head>

<body>

  <!-- LICENSE WALL -->
  <div id="licenseWall">
    <h2>üîí Activaci√≥n</h2>
    <div class="hint">Ingres√° tu c√≥digo para activar esta app en este dispositivo.</div>

    <label for="licenseCodeInput">C√≥digo</label>
    <input id="licenseCodeInput" placeholder="Ej: AGRO-1A2B-3C4D" />

    <button id="licenseActivateBtn" class="btn" style="margin-top:10px; width:100%;">Activar</button>
    <div id="licenseMsg" class="msg bad"></div>
  </div>

  <!-- APP ROOT -->
  <div id="appRoot" style="display:none;">
    <div class="wrap">
      <header>
        <h1>üåæ Recetas de Fumigaci√≥n</h1>
        <div class="pill" id="recipesCountPill">0 recetas</div>
      </header>

      <!-- TAB: USAR -->
      <section id="tabUse">
        <div class="card">
          <h2>Usar receta</h2>

          <label>Receta</label>
          <select id="useRecipeSelect"></select>

          <div class="row">
            <div>
              <label>Hect√°reas</label>
              <input id="useHectares" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Ej: 5" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnCalculate" class="btn" style="width:100%;">Calcular</button>
            </div>
          </div>

          <div id="calcOutput" class="ingredients" style="display:none;"></div>
          <div id="calcMsg" class="msg"></div>
        </div>

        <div class="card">
          <h2>Nueva receta</h2>

          <label>Nombre de la receta</label>
          <input id="newRecipeName" placeholder="Ej: Soja - Malezas" />

          <!-- ‚úÖ NUEVO: Descripci√≥n (justo abajo del nombre) -->
          <label>Descripci√≥n (opcional)</label>
          <textarea id="newRecipeDesc" rows="2" placeholder="Ej: Orden de mezcla, advertencias, momento del d√≠a, etc."></textarea>

          <div class="card" style="background:rgba(255,255,255,.03); margin:12px 0 0; border-style:dashed;">
            <h2 style="margin:0 0 10px; font-size:13px; color:var(--muted);">Ingrediente (por 1 hect√°rea)</h2>
            <div class="row">
              <div>
                <label>Nombre</label>
                <input id="ingName" placeholder="Ej: Glifosato" />
              </div>
              <div>
                <label>Cantidad</label>
                <input id="ingQty" type="number" inputmode="decimal" step="0.001" placeholder="Ej: 2" />
              </div>
              <div>
                <label>Unidad</label>
                <select id="ingUnit">
                  <option value="L">L</option>
                  <option value="mL">mL</option>
                  <option value="kg">kg</option>
                  <option value="g">g</option>
                  <option value="cc">cc</option>
                  <option value="unid">unid</option>
                </select>
              </div>
            </div>
            <button id="btnAddIngredient" class="btn2" style="margin-top:10px; width:100%;">Agregar ingrediente</button>
            <div class="hint">Tip: carg√°s ingredientes por hect√°rea. Luego la app escala autom√°ticamente seg√∫n las hect√°reas.</div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.02); border:1px solid var(--line); margin:12px 0 0;">
            <h2 style="margin:0 0 10px; font-size:13px; color:var(--muted);">Ingredientes cargados</h2>
            <div id="newIngredientsList" class="ingredients"></div>
            <div class="row" style="margin-top:10px;">
              <button id="btnClearDraft" class="btn2">Limpiar</button>
              <button id="btnSaveRecipe" class="btn">Guardar receta</button>
            </div>
            <div id="saveMsg" class="msg"></div>
          </div>
        </div>

        <div class="card">
          <h2>Backup (CSV)</h2>
          <div class="row">
            <button id="btnExportCSV" class="btn2">Exportar CSV</button>
            <label class="btn2" style="display:flex; align-items:center; justify-content:center; cursor:pointer;">
              Importar CSV
              <input id="importCSVFile" type="file" accept=".csv" style="display:none;" />
            </label>
          </div>
          <div id="csvMsg" class="msg"></div>
        </div>
      </section>

      <!-- TAB: ADMIN (editar/borrar) -->
      <section id="tabAdmin" style="display:none;">
        <div class="card">
          <h2>Editar / Borrar recetas</h2>
          <div class="hint">Seleccion√° una receta para editar nombre o ingredientes, o borrarla.</div>

          <label>Receta</label>
          <select id="adminRecipeSelect"></select>

          <div id="adminEditor" style="display:none; margin-top:10px;">
            <label>Nombre</label>
            <input id="adminName" />

            <!-- ‚úÖ NUEVO: Descripci√≥n en el editor -->
            <label>Descripci√≥n (opcional)</label>
            <textarea id="adminDesc" rows="2" placeholder="Notas/indicaciones para esta receta..."></textarea>

            <div class="card" style="background:rgba(255,255,255,.03); margin:12px 0 0; border-style:dashed;">
              <h2 style="margin:0 0 10px; font-size:13px; color:var(--muted);">Ingredientes (por 1 hect√°rea)</h2>
              <div id="adminIngredients" class="ingredients"></div>

              <div class="row" style="margin-top:10px;">
                <button id="btnAdminAddRow" class="btn2">+ Ingrediente</button>
                <button id="btnAdminSave" class="btnOk">Guardar cambios</button>
              </div>
              <button id="btnAdminDelete" class="btnDanger" style="margin-top:10px; width:100%;">Borrar receta</button>
              <div id="adminMsg" class="msg"></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="tabs">
      <div class="tabsInner">
        <button class="tabBtn active" id="tabBtnUse">Usar</button>
        <button class="tabBtn" id="tabBtnAdmin">Editar</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   PWA install + SW
========================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/* =========================
   Storage
========================= */
const STORE_KEY = "fumig_recipes_v1";

function loadRecipes() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function saveRecipes(recipes) {
  localStorage.setItem(STORE_KEY, JSON.stringify(recipes));
}

function uid() {
  return "r_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* =========================
   UI helpers
========================= */
function $(id){ return document.getElementById(id); }

function setActiveTab(tab) {
  const use = $("tabUse");
  const admin = $("tabAdmin");
  const bUse = $("tabBtnUse");
  const bAdmin = $("tabBtnAdmin");

  if (tab === "admin") {
    use.style.display = "none";
    admin.style.display = "block";
    bUse.classList.remove("active");
    bAdmin.classList.add("active");
  } else {
    use.style.display = "block";
    admin.style.display = "none";
    bUse.classList.add("active");
    bAdmin.classList.remove("active");
  }
}

/* =========================
   Draft new recipe
========================= */
let draftIngredients = [];

function renderDraftIngredients() {
  const box = $("newIngredientsList");
  box.innerHTML = "";

  if (draftIngredients.length === 0) {
    box.innerHTML = `<div class="hint">Todav√≠a no agregaste ingredientes.</div>`;
    return;
  }

  draftIngredients.forEach((ing, idx) => {
    const row = document.createElement("div");
    row.className = "ingRow";
    row.innerHTML = `
      <span>${ing.name}</span>
      <span>${ing.qty} ${ing.unit} <button class="btn2" data-rm="${idx}" style="padding:6px 10px; margin-left:8px;">Quitar</button></span>
    `;
    box.appendChild(row);
  });

  box.querySelectorAll("button[data-rm]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = Number(btn.getAttribute("data-rm"));
      draftIngredients.splice(i,1);
      renderDraftIngredients();
    });
  });
}

/* =========================
   Recipes render
========================= */
function renderRecipeSelects(recipes) {
  const useSel = $("useRecipeSelect");
  const adminSel = $("adminRecipeSelect");

  function fill(sel) {
    sel.innerHTML = "";
    if (recipes.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No hay recetas (cre√° una)";
      sel.appendChild(opt);
      sel.disabled = true;
    } else {
      sel.disabled = false;
      recipes
        .slice()
        .sort((a,b)=>a.name.localeCompare(b.name))
        .forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = r.name;
          sel.appendChild(opt);
        });
    }
  }

  fill(useSel);
  fill(adminSel);

  $("recipesCountPill").textContent = `${recipes.length} receta${recipes.length===1?"":"s"}`;
}

/* =========================
   Calculate
========================= */
function formatNumber(n) {
  // mant√©n 3 decimales si hace falta, si no, corta lindo
  const x = Number(n);
  if (!isFinite(x)) return "";
  const abs = Math.abs(x);
  const decimals = abs >= 10 ? 2 : abs >= 1 ? 3 : 4;
  return x.toFixed(decimals).replace(/\.?0+$/,"");
}

function calculateForHectares(recipe, ha) {
  return recipe.ingredients.map(ing => ({
    name: ing.name,
    qty: Number(ing.qty) * ha,
    unit: ing.unit
  }));
}

function renderCalcOutput(lines) {
  const out = $("calcOutput");
  out.style.display = "grid";
  out.innerHTML = "";
  lines.forEach(l => {
    const row = document.createElement("div");
    row.className = "ingRow";
    row.innerHTML = `<span>${l.name}</span><span>${formatNumber(l.qty)} ${l.unit}</span>`;
    out.appendChild(row);
  });
}

/* =========================
   CSV Export/Import
   Nuevo formato compatible:
   recipe_id,recipe_name,recipe_desc,ingredient_name,qty,unit
   (si el CSV viejo NO tiene recipe_desc, igual se importa)
========================= */
function recipesToCSV(recipes) {
  const header = ["recipe_id","recipe_name","recipe_desc","ingredient_name","qty","unit"];
  const rows = [header.join(",")];

  recipes.forEach(r => {
    const desc = r.desc || "";
    r.ingredients.forEach(ing => {
      const line = [
        r.id,
        escapeCSV(r.name),
        escapeCSV(desc),
        escapeCSV(ing.name),
        ing.qty,
        ing.unit
      ].join(",");
      rows.push(line);
    });
    if (r.ingredients.length === 0) {
      // allow empty recipe
      rows.push([r.id, escapeCSV(r.name), escapeCSV(desc), "", "", ""].join(","));
    }
  });

  return rows.join("\n");
}

function escapeCSV(s) {
  const str = String(s ?? "");
  if (/[,"\n]/.test(str)) return `"${str.replaceAll('"','""')}"`;
  return str;
}

function parseCSV(text) {
  // Simple CSV parser for our schema (handles quoted strings)
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lines.length < 1) return [];

  const header = splitCSVLine(lines[0]);

  const idx = {
    recipe_id: header.indexOf("recipe_id"),
    recipe_name: header.indexOf("recipe_name"),
    recipe_desc: header.indexOf("recipe_desc"), // puede ser -1
    ingredient_name: header.indexOf("ingredient_name"),
    qty: header.indexOf("qty"),
    unit: header.indexOf("unit")
  };

  // requeridos m√≠nimos
  if (idx.recipe_id === -1 || idx.recipe_name === -1 || idx.ingredient_name === -1 || idx.qty === -1 || idx.unit === -1) {
    throw new Error("CSV inv√°lido: faltan columnas.");
  }

  const map = new Map();
  for (let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const rid = cols[idx.recipe_id] || "";
    const rname = cols[idx.recipe_name] || "";
    const rdesc = (idx.recipe_desc !== -1 ? (cols[idx.recipe_desc] || "") : "");

    if (!rid) continue;

    if (!map.has(rid)) {
      map.set(rid, { id: rid, name: rname, desc: rdesc, ingredients: [] });
    }
    const r = map.get(rid);

    if (rname) r.name = rname;
    if (idx.recipe_desc !== -1 && rdesc) r.desc = rdesc;

    const iname = cols[idx.ingredient_name] || "";
    const qty = cols[idx.qty];
    const unit = cols[idx.unit] || "";

    if (iname && qty && unit) {
      r.ingredients.push({ name: iname, qty: Number(qty), unit });
    }
  }

  return Array.from(map.values()).map(r => ({
    id: r.id,
    name: r.name,
    desc: r.desc || "",
    ingredients: r.ingredients || []
  }));
}

function splitCSVLine(line) {
  const out = [];
  let cur = "";
  let inQ = false;

  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (inQ) {
      if (ch === '"') {
        if (line[i+1] === '"') { cur += '"'; i++; }
        else inQ = false;
      } else cur += ch;
    } else {
      if (ch === '"') inQ = true;
      else if (ch === ',') { out.push(cur); cur = ""; }
      else cur += ch;
    }
  }
  out.push(cur);
  return out;
}

/* =========================
   Admin editor
========================= */
function renderAdminEditor(recipe) {
  const editor = $("adminEditor");
  const box = $("adminIngredients");
  const msg = $("adminMsg");
  msg.textContent = "";

  if (!recipe) {
    editor.style.display = "none";
    return;
  }
  editor.style.display = "block";
  $("adminName").value = recipe.name;
  $("adminDesc").value = recipe.desc || "";

  function draw() {
    box.innerHTML = "";
    recipe.ingredients.forEach((ing, idx) => {
      const row = document.createElement("div");
      row.className = "row";
      row.style.alignItems = "center";
      row.innerHTML = `
        <input data-f="name" data-i="${idx}" value="${escapeHtml(ing.name)}" placeholder="Ingrediente" />
        <input data-f="qty" data-i="${idx}" type="number" step="0.001" inputmode="decimal" value="${ing.qty}" placeholder="Cant." />
        <select data-f="unit" data-i="${idx}">
          ${["L","mL","kg","g","cc","unid"].map(u => `<option value="${u}" ${u===ing.unit?"selected":""}>${u}</option>`).join("")}
        </select>
        <button class="btnDanger" data-rm="${idx}" style="padding:10px 12px;">Quitar</button>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll("button[data-rm]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-rm"));
        recipe.ingredients.splice(i,1);
        draw();
      });
    });

    // live update fields
    box.querySelectorAll("input[data-f], select[data-f]").forEach(el => {
      el.addEventListener("input", () => {
        const i = Number(el.getAttribute("data-i"));
        const f = el.getAttribute("data-f");
        if (f === "qty") recipe.ingredients[i][f] = Number(el.value);
        else recipe.ingredients[i][f] = el.value;
      });
      el.addEventListener("change", () => {
        const i = Number(el.getAttribute("data-i"));
        const f = el.getAttribute("data-f");
        if (f === "qty") recipe.ingredients[i][f] = Number(el.value);
        else recipe.ingredients[i][f] = el.value;
      });
    });
  }

  draw();

  $("btnAdminAddRow").onclick = () => {
    recipe.ingredients.push({ name: "", qty: 0, unit: "L" });
    draw();
  };

  $("btnAdminSave").onclick = () => {
    const newName = $("adminName").value.trim();
    const newDesc = $("adminDesc").value.trim();

    if (!newName) { msg.textContent = "Pon√© un nombre."; msg.className="msg bad"; return; }

    recipe.name = newName;
    recipe.desc = newDesc;

    recipe.ingredients = recipe.ingredients
      .map(x => ({ name: String(x.name||"").trim(), qty: Number(x.qty), unit: String(x.unit||"").trim() }))
      .filter(x => x.name && isFinite(x.qty) && x.qty >= 0 && x.unit);

    const all = loadRecipes();
    const idx = all.findIndex(r => r.id === recipe.id);
    if (idx !== -1) {
      all[idx] = recipe;
      saveRecipes(all);
    }
    msg.textContent = "Cambios guardados.";
    msg.className = "msg ok";
    refreshUI();
  };

  $("btnAdminDelete").onclick = () => {
    const all = loadRecipes();
    const filtered = all.filter(r => r.id !== recipe.id);
    saveRecipes(filtered);
    msg.textContent = "Receta borrada.";
    msg.className = "msg ok";
    refreshUI();
    // reselect
    $("adminRecipeSelect").value = filtered[0]?.id || "";
    handleAdminSelect();
  };
}

function escapeHtml(s){
  return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

/* =========================
   UI Refresh
========================= */
function refreshUI() {
  const recipes = loadRecipes();
  renderRecipeSelects(recipes);
  // keep selections stable if possible
  if (recipes.length > 0) {
    if (!$("useRecipeSelect").value) $("useRecipeSelect").value = recipes[0].id;
    if (!$("adminRecipeSelect").value) $("adminRecipeSelect").value = recipes[0].id;
  }
}

/* =========================
   Events
========================= */
$("tabBtnUse").onclick = () => setActiveTab("use");
$("tabBtnAdmin").onclick = () => {
  setActiveTab("admin");
  handleAdminSelect();
};

$("btnAddIngredient").onclick = () => {
  const name = $("ingName").value.trim();
  const qty = Number($("ingQty").value);
  const unit = $("ingUnit").value;

  if (!name) { $("saveMsg").textContent="Pon√© nombre del ingrediente."; $("saveMsg").className="msg bad"; return; }
  if (!isFinite(qty) || qty <= 0) { $("saveMsg").textContent="La cantidad debe ser mayor a 0."; $("saveMsg").className="msg bad"; return; }

  draftIngredients.push({ name, qty, unit });
  $("ingName").value = "";
  $("ingQty").value = "";
  $("saveMsg").textContent = "";
  renderDraftIngredients();
};

$("btnClearDraft").onclick = () => {
  draftIngredients = [];
  $("newRecipeName").value = "";
  $("newRecipeDesc").value = ""; /* ‚úÖ NUEVO */
  $("saveMsg").textContent = "";
  renderDraftIngredients();
};

$("btnSaveRecipe").onclick = () => {
  const name = $("newRecipeName").value.trim();
  const desc = $("newRecipeDesc").value.trim(); /* ‚úÖ NUEVO */

  if (!name) { $("saveMsg").textContent="Pon√© un nombre de receta."; $("saveMsg").className="msg bad"; return; }
  if (draftIngredients.length === 0) { $("saveMsg").textContent="Agreg√° al menos 1 ingrediente."; $("saveMsg").className="msg bad"; return; }

  const recipes = loadRecipes();
  const newR = {
    id: uid(),
    name,
    desc, /* ‚úÖ NUEVO */
    ingredients: draftIngredients.map(x => ({ name: x.name, qty: Number(x.qty), unit: x.unit }))
  };
  recipes.push(newR);
  saveRecipes(recipes);

  $("saveMsg").textContent = "Receta guardada.";
  $("saveMsg").className = "msg ok";
  draftIngredients = [];
  renderDraftIngredients();
  $("newRecipeName").value = "";
  $("newRecipeDesc").value = ""; /* ‚úÖ NUEVO */

  refreshUI();
};

$("btnCalculate").onclick = () => {
  const recipes = loadRecipes();
  const rid = $("useRecipeSelect").value;
  const recipe = recipes.find(r => r.id === rid);
  const ha = Number($("useHectares").value);

  $("calcMsg").textContent = "";
  $("calcOutput").style.display = "none";
  $("calcOutput").innerHTML = "";

  if (!recipe) { $("calcMsg").textContent="No hay receta seleccionada."; return; }
  if (!isFinite(ha) || ha <= 0) { $("calcMsg").textContent="Ingres√° hect√°reas v√°lidas (>0)."; return; }

  const lines = calculateForHectares(recipe, ha);
  renderCalcOutput(lines);
};

$("btnExportCSV").onclick = () => {
  const recipes = loadRecipes();
  if (recipes.length === 0) {
    $("csvMsg").textContent = "No hay recetas para exportar.";
    return;
  }
  const csv = recipesToCSV(recipes);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "recetas_fumigacion.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  $("csvMsg").textContent = "CSV exportado.";
};

$("importCSVFile").addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const imported = parseCSV(text);

    if (!Array.isArray(imported) || imported.length === 0) {
      $("csvMsg").textContent = "CSV vac√≠o o inv√°lido.";
      return;
    }

    // Merge by recipe id; if collision, keep imported name/ings/desc
    const current = loadRecipes();
    const map = new Map(current.map(r => [r.id, r]));
    imported.forEach(r => map.set(r.id, r));
    const merged = Array.from(map.values());

    saveRecipes(merged);
    refreshUI();

    $("csvMsg").textContent = "CSV importado correctamente.";
  } catch (err) {
    $("csvMsg").textContent = "Error importando CSV: " + (err?.message || String(err));
  } finally {
    e.target.value = "";
  }
});

function handleAdminSelect() {
  const recipes = loadRecipes();
  const rid = $("adminRecipeSelect").value;
  const r = recipes.find(x => x.id === rid);
  if (!r) { renderAdminEditor(null); return; }

  // Make a deep copy for editing
  const copy = {
    id: r.id,
    name: r.name,
    desc: r.desc || "", /* ‚úÖ NUEVO */
    ingredients: (r.ingredients || []).map(i => ({ name: i.name, qty: i.qty, unit: i.unit }))
  };
  renderAdminEditor(copy);
}

/* =========================
   Init UI
========================= */
renderDraftIngredients();
refreshUI();

/* =========================
   LICENSE WALL (robusto)
========================= */
const DEVICE_KEY="fumig_device_id_v1";
const LICENSE_KEY="fumig_license_v1";

function getDeviceId(){
  let id=localStorage.getItem(DEVICE_KEY);
  if(!id){
    id = (crypto.randomUUID ? crypto.randomUUID() : ("dev-" + Math.random().toString(16).slice(2)));
    localStorage.setItem(DEVICE_KEY,id);
  }
  return id;
}

function showWall(show){
  const wall = $("licenseWall");
  const app = $("appRoot");
  if (!wall || !app) return;
  wall.style.display = show ? "block" : "none";
  app.style.display = show ? "none" : "block";
}

function getLicenseState(){
  try { return JSON.parse(localStorage.getItem(LICENSE_KEY) || "null"); }
  catch { return null; }
}

function setLicenseMsg(text, ok=false){
  const el = $("licenseMsg");
  el.textContent = text || "";
  el.className = "msg " + (ok ? "ok" : "bad");
}

async function activate(code){
  const res = await fetch("/.netlify/functions/activate",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ code, deviceId:getDeviceId() })
  });

  const text = await res.text();
  try { return JSON.parse(text); }
  catch { return { ok:false, reason:`Respuesta no-JSON (${res.status}): ${text.slice(0,200)}` }; }
}

document.addEventListener("DOMContentLoaded", () => {
  // Sanity: IDs
  const required = ["licenseWall","appRoot","licenseCodeInput","licenseActivateBtn","licenseMsg"];
  for (const id of required){
    if (!$(id)) {
      console.error("Falta elemento:", id);
      // Si falta, mostramos app para no dejar al usuario en blanco
      $("appRoot").style.display = "block";
      return;
    }
  }

  const deviceId = getDeviceId();
  const lic = getLicenseState();

  if (lic?.activated && lic.deviceId === deviceId) {
    showWall(false);
    return;
  }

  showWall(true);
  setLicenseMsg("");

  $("licenseActivateBtn").addEventListener("click", async () => {
    setLicenseMsg("");
    const code = $("licenseCodeInput").value.trim();
    if (!code) { setLicenseMsg("Ingres√° un c√≥digo."); return; }

    $("licenseActivateBtn").disabled = true;
    $("licenseActivateBtn").textContent = "Activando...";

    try{
      const r = await activate(code);
      if (!r.ok) {
        setLicenseMsg(r.reason || "Activaci√≥n fallida.");
        $("licenseActivateBtn").disabled = false;
        $("licenseActivateBtn").textContent = "Activar";
        return;
      }

      localStorage.setItem(LICENSE_KEY, JSON.stringify({
        activated:true,
        deviceId,
        activatedAt: new Date().toISOString()
      }));

      showWall(false);
    } catch (e) {
      console.error(e);
      setLicenseMsg("Error de conexi√≥n o servidor.");
      $("licenseActivateBtn").disabled = false;
      $("licenseActivateBtn").textContent = "Activar";
    }
  });
});
</script>

</body>
</html>
